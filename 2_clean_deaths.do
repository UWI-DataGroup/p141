** HEADER -----------------------------------------------------
**  DO-FILE METADATA
    //  algorithm name          2_clean_deaths.do
    //  project:                BNR
    //  analysts:               Jacqueline CAMPBELL
    //  date first created      07-SEP-2020
    // 	date last modified      07-SEP-2020
    //  algorithm task          Clean death data
    //  status                  Completed
    //  objectve                To have one dataset with cleaned 2019 death data.
    //  note                    Cleaned 2019 dataset to be merged with 2008-2020 death dataset; 
    //                          Redcap database with ALL cleaned deaths to be created.

    
    ** General algorithm set-up
    version 16
    clear all
    macro drop _all
    set more off

    ** Initialising the STATA log and allow automatic page scrolling
    capture {
            program drop _all
    	drop _all
    	log close
    	}

    ** Set working directories: this is for DATASET and LOGFILE import and export
    ** DATASETS to encrypted SharePoint folder
    local datapath "X:/The University of the West Indies/DataGroup - repo_data/data_p141"
    ** LOGFILES to unencrypted OneDrive folder (.gitignore set to IGNORE log files on PUSH to GitHub)
    local logpath X:/OneDrive - The University of the West Indies/repo_datagroup/repo_p141

    ** Close any open log file and open a new log file
    capture log close
    log using "`logpath'\2_clean_deaths_2019_v02.smcl", replace
** HEADER -----------------------------------------------------

***************
** LOAD DATASET  
***************
use "`datapath'\version03\2-working\2019_deaths_prepped_dp_v02"

count //2,195


*****************
** DATA QUALITY  
*****************
** Create quality report - corrections per DA
forvalues j=1/61 {
	gen flag`j'=0
}

label var flag1 "Record ID"
label var flag2 "Redcap Event"
label var flag3 "ABS DateTime"
label var flag4 "ABS DA"
label var flag5 "ABS Other DA"
label var flag6 "Certificate Type"
label var flag7 "ABS Reg Dept #"
label var flag8 "ABS District"
label var flag9 "Pt Name"
label var flag10 "Pt Address"
label var flag11 "Pt Parish"
label var flag12 "Sex"
label var flag13 "Age"
label var flag14 "Age (time period)"
label var flag15 "Date of Death"
label var flag16 "Death Year"
label var flag17 "NRN documented?"
label var flag18 "NRN"
label var flag19 "Marital Status"
label var flag20 "Occupation"
label var flag21 "Duration"
label var flag22 "Duration (time period)"
label var flag23 "COD 1a"
label var flag24 "Onset 1a"
label var flag25 "Onset 1a (time period)"
label var flag26 "COD 1b"
label var flag27 "Onset 1b"
label var flag28 "Onset 1b (time period)"
label var flag29 "COD 1c"
label var flag30 "Onset 1c"
label var flag31 "Onset 1c (time period)"
label var flag32 "COD 1d"
label var flag33 "Onset 1d"
label var flag34 "Onset 1d (time period)"
label var flag35 "COD 2a"
label var flag36 "Onset 2a"
label var flag37 "Onset 2a (time period)"
label var flag38 "COD 2b"
label var flag39 "Onset 2b"
label var flag40 "Onset 2b (time period)"
label var flag41 "Place of Death"
label var flag42 "Death Parish"
label var flag43 "Reg Date"
label var flag44 "Certifier"
label var flag45 "Certifer Address"
label var flag46 "Name Match"
label var flag47 "Cleaned?"
label var flag48 "ABS Complete?"
label var flag49 "TF Date Start"
label var flag50 "TF Time Start"
label var flag51 "TF DA"
label var flag52 "TF Reg # START"
label var flag53 "TF District START"
label var flag54 "TF Reg # END"
label var flag55 "TF District END"
label var flag56 "TF Date End"
label var flag57 "TF Time End"
label var flag58 "TF Time Elapsed (hrs)"
label var flag59 "TF Time Elapsed (mins)"
label var flag60 "TF Comments"
label var flag61 "TF Complete?"


gen corr_AH=0 //DA code=25
gen corr_KG=0 //DA code=04
gen corr_NR=0 //DA code=20
gen corr_KWG=0 //DA code=13
gen corr_TH=0 //DA code=14
gen corr_intern=0 //DA code=98


*****************
** DATA CLEANING  
*****************
** CLEAN each variable according to below consistency checks and the quality rules in DeathData REDCap database

************************
**  DEATH CERTIFICATE **
**        FORM        **
************************
sort record_id
** record_id (auto-generated by REDCap): FLAG 1
** (1) missing/duplicate
count if record_id==. //0
duplicates list record_id, nolabel sepby(record_id) //1 - record_id=2531
replace record_id=3289 if record_id==2531 & redcap_event_name=="tracking_arm_2"

** event (auto-generated by REDCap): FLAG 2
** (2) missing
count if event==. //0


** dddoa: Y-M-D H:M, readonly: FLAG 3
** (3) missing
count if event==1 & dddoa==. //0


** ddda: FLAG 4
** (4) missing
count if event==1 & ddda==. //1
count if event==1 & (ddda!=4 & ddda!=13 & ddda!=14 & ddda!=20 & ddda!=25 & ddda!=98) //2 - check in Logging in REDCap db
//list record_id ddda if event==1 & (ddda!=4 & ddda!=13 & ddda!=14 & ddda!=20 & ddda!=25 & ddda!=98)
replace ddda=14 if record_id==2475|record_id==2883 //2 changes
replace flag4=flag4+1 if record_id==2475|record_id==2883
replace corr_TH=corr_TH+1 if record_id==2475|record_id==2883

** odda: FLAG 5
** (5) missing
count if ddda==98 & odda=="" //0
** (6) invalid
count if ddda!=98 & odda!="" //0
//list record_id event dddoa ddda odda if ddda!=98 & odda!=""


** certtype: 1=MEDICAL 2=POST MORTEM 3=CORONER 99=ND, required: FLAG 6
** (7) missing
count if event==1 & certtype==. //1 - record_id 2475 which is entirely blank so remove
//list record_id event dddoa ddda certtype if event==1 & certtype==.
drop if record_id==2475 //1 deleted


** regnum: integer, if missing=9999: FLAG 7
** (8) missing
count if event==1 & regnum==.|event==1 & regnum==0 //1 - record_id 3265 which is entirely blank so remove
//list record_id ddda regnum if event==1 & regnum==.|event==1 & regnum==0
drop if record_id==3265 //1 deleted
** (9) invalid
count if event==1 & regnum>9999 //0
** (9) duplicate
sort regnum district
quietly by regnum district:  gen dupreg = cond(_N==1,0,_n)
sort regnum district
count if event==1 & dupreg>0  //32 - different DAs entered same certificates
sort pname record_id
//list record_id dddoa ddda odda pname regnum district nrn if event==1 & dupreg>0
drop if record_id==2775|record_id==2429|record_id==2774|record_id==2434|record_id==2899 ///
		|record_id==2887|record_id==2895|record_id==2785|record_id==2801 //9 deleted


** district: 1=A 2=B 3=C 4=D 5=E 6=F: FLAG 8
** (10) missing
count if event==1 & district==. //0


** pname: Text, if missing=99: FLAG 9
** (11) missing
count if event==1 & pname=="" //0
** (12) invalid
count if event==1 & regexm(pname, "[a-z]") //78 - query with KG re 1853 in 2019 db
//list record_id event ddda odda pname if event==1 & regexm(pname, "[a-z]")
replace flag9=flag9+1 if event==1 & regexm(pname, "[a-z]") //78 changes
replace corr_intern=corr_intern+1 if event==1 & regexm(pname, "[a-z]") //78 changes
replace pname=upper(pname) //78 changes
count if event==1 & regexm(pname,"NIL")|event==1 & regexm(pname,"ND") //89 - all correct
//list record_id ddda odda pname if event==1 & regexm(pname,"NIL")|event==1 & regexm(pname,"ND")
** (13) duplicate
sort pname
quietly by pname:  gen dup = cond(_N==1,0,_n)
sort pname
count if event==1 & dup>0  //62 - different DAs entered same certificates
sort pname record_id
//list record_id dddoa ddda odda pname regnum district nrn if event==1 & dup>0
replace namematch=1 if record_id==2569|record_id==2641|record_id==2556|record_id==3111 //4 changes

drop if event==1 & dup>0 & namematch==. //58 deleted
drop dup


** address: Text, if missing=99: FLAG 10
** (14) missing
count if event==1 & address=="" //0
** (15) invalid 
count if event==1 & regexm(address, "[a-z]") //75
//list record_id event ddda odda address if event==1 & regexm(address, "[a-z]")
replace flag10=flag10+1 if event==1 & regexm(address, "[a-z]") //75 changes
replace corr_intern=corr_intern+1 if event==1 & regexm(address, "[a-z]") //75 changes
replace address=upper(address) //75 changes
count if event==1 & regexm(address,"NIL")|event==1 & regexm(address,"ND") //160 - all correct
//list record_id ddda odda address if event==1 & regexm(address,"NIL")|event==1 & regexm(address,"ND")


** parish: FLAG 11
** (16) missing
count if event==1 & parish==. //0


** sex:	1=Male 2=Female 99=ND: FLAG 12
** (17) missing
count if event==1 & sex==. //0
//list record_id event ddda pname sex if event==1 & sex==.
** (18) invalid - female with prostate
count if sex==2 & (regexm(cod1a, "PROSTAT")|regexm(cod1b, "PROSTAT")|regexm(cod1c, "PROSTAT") ///
		|regexm(cod1d, "PROSTAT")|regexm(cod2a, "PROSTAT")|regexm(cod2b, "PROSTAT")) //0
//list record_id ddda pname nrn sex cod* if (regexm(cod1a, "PROSTAT")|regexm(cod1b, "PROSTAT")|regexm(cod1c, "PROSTAT")|regexm(cod1d, "PROSTAT")|regexm(cod2a, "PROSTAT")|regexm(cod2b, "PROSTAT")) & sex==2
//recode sex 2=1 if record_id==1634 //1 change
//replace flag12=flag12+1 if record_id==1634 //1 change
//replace corr_intern=corr_intern+1 if record_id==1634 //1 change
** (19) visual check - first names for those missing nrn
count if sex==1 & nrn==. //25 - check if there is a stata check for this e.g. soundex,etc - 0 changes
//list record_id ddda pname sex if sex==1 & nrn==.
//recode sex 1=2 if record_id== //0 changes
//replace corr_AH=corr_AH+1 if record_id==1311|record_id==1309 //2 changes
//replace corr_KG=corr_KG+1 if record_id==891 //1 change
//replace corr_NR=corr_NR+1 if record_id==1723 //1 change
** (20) invalid - male with female genital cod
count if sex==1 & (regexm(cod1a, "UTER") | regexm(cod1a, "OMA OF THE VULVA") | ///
			regexm(cod1a, "CHORIOCARCIN") | regexm(cod1a, "ENDOMETRIAL CARCINOMA") | ///
			regexm(cod1a, "ENDOMETRIAL CANC") | regexm(cod1a, "OF ENDOMETRIUM") | ///
			regexm(cod1a, "OF THE ENDOMETRIUM") | regexm(cod1a, "VULVA CARCINOMA") | ///
			regexm(cod1a, "VULVAL CANCER") | regexm(cod1a, "VAGINAL CARCINOMA")|regexm(cod1a, "ENDOMETRIUM")) //0
/*list record_id ddda pname nrn sex cod* if sex==1 & (regexm(cod1a, "UTER") | regexm(cod1a, "OMA OF THE VULVA") | ///
			regexm(cod1a, "CHORIOCARCIN") | regexm(cod1a, "ENDOMETRIAL CARCINOMA") | ///
			regexm(cod1a, "ENDOMETRIAL CANC") | regexm(cod1a, "OF ENDOMETRIUM") | ///
			regexm(cod1a, "OF THE ENDOMETRIUM") | regexm(cod1a, "VULVA CARCINOMA") | ///
			regexm(cod1a, "VULVAL CANCER") | regexm(cod1a, "VAGINAL CARCINOMA")|regexm(cod1a, "ENDOMETRIUM"))
*/
//recode sex 1=2 if record_id==70|record_id==711 //2 changes
//replace flag12=flag12+1 if record_id==70|record_id==711 //2 changes
//replace corr_KG=corr_KG+1 if record_id==70|record_id==711 //2 changes
** (21) visual check - first names for those missing nrn
count if sex==2 & nrn==. //13 - check if there is a stata check for this e.g. soundex,etc - 0 changes
//list record_id ddda pname sex if sex==2 & nrn==.


** age: Integer - min=0, max=999: FLAG 13
** (22) missing
count if event==1 & age==. //0
** (23) missing - NRN not missing
count if (age==.|age==0) & nrn!=. //0


** agetxt - 1 "Minutes" 2 "Hours" 3 "Days" 4 "Weeks" 5 "Months" 6 "Years" 99 "ND": FLAG 14
** (25) missing
count if age!=. & agetxt==. //0
** (26) invalid
count if age==999 & agetxt!=99 //0
** (27) visual check - NRN vs agetxt
count if nrn!=. & age!=. & agetxt!=6 //1 - correct
//list record_id ddda odda dod nrn age agetxt if nrn!=. & age!=. & agetxt!=6 //checked these using redcap db & electoral list
//replace agetxt=6 if record_id==1806|record_id==1850 //2 changes
//replace flag14=flag14+1 if record_id==1806|record_id==1850 //2 changes
//replace corr_KG=corr_KG+1 if record_id==1806|record_id==1850 //2 changes


** dod: Y-M-D (need to clean dod before other checks): FLAG 15
** (28) missing
count if event==1 & dod==. //0
** (29) invalid - future date
gen currentd=c(current_date)
gen double today=date(currentd, "DMY")
drop currentd
format today %tdCCYY-NN-DD
count if event==1 & dod>today //0
sort record_id
//list record_id ddda dod regdate pname if event==1 & dod>today
** (30) invalid - after reg date
count if event==1 & dod>regdate //3 (check redcapdb for if any coroner cases; 2019 TF redcap report for 'true' 2019 cases)
//list record_id ddda odda dod regdate pname if event==1 & dod>regdate
replace flag15=flag15+1 if event==1 & dod>regdate
replace dod=d(06sep2019) if record_id==2597 //1 change
replace regdate=d(28oct2019) if record_id==2597 //1 change
replace dod=d(12dec2019) if record_id==3059 //1 change
replace regdate=d(13dec2019) if record_id==3059 //1 change
replace dod=d(31jul2019) if record_id==3212 //1 change
replace regdate=d(12dec2019) if record_id==3212 //1 change
replace corr_KG=corr_KG+1 if record_id==2597 //1 change
replace corr_intern=corr_intern+1 if record_id==3059|record_id==3212 //2 changes
//swapval regdate dod if dod>regdate //ssc install swapval - doesn't work for dates, only for numeric or string values
//gen dod2=regdate if dod>regdate
//gen regdate2=dod if dod>regdate
//format dod2 regdate2 %tdCCYY-NN-DD
//replace dod=dod2 if dod2!=. //9 changes
//replace regdate=regdate2 if regdate2!=. //9 changes
//drop dod2 regdate2



** dodyear (not included in single year Redcap db but done for multi-year Redcap db): FLAG 16
** (31) missing
count if event==1 & dodyear==. //0
//list record_id ddda dod regdate if event==1 & dodyear==.
** (32) invalid - deaths before/after 2019
count if event==1 & dodyear!=2019 //41
//list record_id ddda odda dod dodyear pname nrn regdate if event==1 & dodyear!=2019
//tab dodyear if event==1,m
/*
    Year of |
      Death |      Freq.     Percent        Cum.
------------+-----------------------------------
       2018 |          1        0.10        0.10 - checked against REDCap multi year db; not there so keep in here
       2019 |        944       95.84       95.94
       2020 |         40        4.06      100.00 - checked against REDCap 2020 db; all in there so remove from here
------------+-----------------------------------
      Total |        985      100.00
*/
drop if event==1 & dodyear>2019 //40 deleted

** nrnnd: 1=Yes 2=No: FLAG 17
** (33) missing
count if event==1 & nrnnd==. //0
//list record_id ddda nrn if event==1 & nrnnd==.
** (34) invalid
count if event==1 & nrn==. & nrnnd==1 //0
** (35) invalid
count if nrn!=. & nrnnd==2 //0

** nrn: dob-####, partial missing=dob-9999, if missing=.: FLAG 18
tostring nrn, gen(natregno) format("%15.0f")
replace natregno="" if natregno=="." //76 changes
** (36) missing
count if event==1 & nrnnd==1 & (natregno==""|natregno=="9999999999") //0
** (37) invalid - length (checked against electoral list; no error for DA if leading zero was in redcap db)
count if natregno!="" & length(natregno)!=10 //22
//list record_id ddda odda pname age nrn natregno if natregno!="" & length(natregno)!=10
replace flag18=flag18+1 if natregno!="" & length(natregno)!=10 //22 changes
replace corr_intern=corr_intern+1 if natregno!="" & length(natregno)!=10 & ddda==98 //12 changes
replace corr_TH=corr_TH+1 if record_id==2880 //1 change
replace corr_AH=corr_AH+1 if record_id==2313|record_id==2552|record_id==3072|record_id==3133 //4 changes
replace corr_KG=corr_KG+1 if record_id==2599|record_id==2615|record_id==3247|record_id==3268 //4 changes
replace natregno=subinstr(natregno,"1","01",.) if record_id==2240 //1 change
replace natregno=subinstr(natregno,"7","07",.) if record_id==2272 //1 change
replace natregno=subinstr(natregno,"11","1",.) if record_id==2313 //1 change
replace natregno=subinstr(natregno,"1","10035",.) if record_id==2345 //1 change
replace natregno=subinstr(natregno,"9","97001",.) if record_id==2358 //1 change
replace natregno=subinstr(natregno,"06","6",.) if record_id==2359 //1 change
replace natregno=subinstr(natregno,"7","07",.) if record_id==2371 //1 change
replace pname=subinstr(pname,"X","C",.) if record_id==2371 //1 change
replace natregno=subinstr(natregno,"8","80093",.) if record_id==2386 //1 change
replace natregno=subinstr(natregno,"00","0",.) if record_id==2552 //1 change
replace natregno=subinstr(natregno,"4","49",.) if record_id==2587 //1 change
replace natregno=subinstr(natregno,"2","20046",.) if record_id==2599 //1 change
replace natregno=subinstr(natregno,"05","015",.) if record_id==2615 //1 change
replace natregno=subinstr(natregno,"70","070",.) if record_id==2761 //1 change
replace natregno=subinstr(natregno,"3","03",.) if record_id==2880 //1 change
replace natregno=subinstr(natregno,"64","4",.) if record_id==3035 //1 change
replace pname=subinstr(pname,"NGTON","GAN",.) if record_id==3035 //1 change
replace natregno=subinstr(natregno,"31","031",.) if record_id==3057 //1 change
replace natregno=subinstr(natregno,"33","3",.) if record_id==3072 //1 change
replace natregno=subinstr(natregno,"9","09",.) if record_id==3133 //1 change
replace natregno=subinstr(natregno,"01","31",.) if record_id==3133 //1 change
replace natregno=subinstr(natregno,"5","05",.) if record_id==3155 //1 change
replace natregno=subinstr(natregno,"10","100",.) if record_id==3194 //1 change
replace natregno=subinstr(natregno,"50","050",.) if record_id==3247 //1 change
replace natregno=subinstr(natregno,"8","08",.) if record_id==3268 //1 change

** (38) invalid - dob but missing nrn #
count if regexm(natregno,"9999")|regexm(natregno,"99") //8 (checked against electoral list)
//list record_id ddda odda natregno pname if regexm(natregno,"9999")|regexm(natregno,"99")
//replace flag18=flag18+1 if record_id==277|record_id==373|record_id==420|record_id==815|record_id==1341|record_id==1904|record_id==2006 //7 changes
** (39) invalid - female with 'male' NRN
count if sex==2 & (regex(substr(natregno,-2,1), "[1,3,5,7,9]")) & !(strmatch(strupper(natregno), "*-9999*")) //4
//list record_id ddda pname natregno sex cod* if sex==2 & (regex(substr(natregno,-2,1), "[1,3,5,7,9]")) & !(strmatch(strupper(natregno), "*-9999*"))
recode sex 2=1 if record_id==3046 //1 change
replace flag12=flag12+1 if record_id==3046 //1 change
replace corr_intern=corr_intern+1 if record_id==3046
** (40) invalid - male with 'female' NRN
count if sex==1 & regex(substr(natregno,-2,1), "[0,2,4,6,8]") //8
//list record_id ddda pname natregno sex cod* if sex==1 & regex(substr(natregno,-2,1), "[0,2,4,6,8]")
recode sex 1=2 if record_id==2355 //1 change
replace flag12=flag12+1 if record_id==2355 //1 change
replace corr_intern=corr_intern+1 if record_id==2355 //1 change
** (41) invalid - age vs dob(nrn)
gen dobyr=substr(natregno, 1, 2) if natregno!=""
gen dobmon=substr(natregno, 3, 2) if natregno!=""
gen dobday=substr(natregno, 5, 2) if natregno!=""
count if (agetxt!=6 & natregno!="")|regex(substr(dobyr,1,1),"[0]") //10
//list record_id pname age agetxt dod natregno dobyr dobmon dobday if (agetxt!=6 & natregno!="")|regex(substr(dobyr,1,1),"[0]")
replace dobyr="19"+dobyr if record_id==2761|record_id==3268 //2 changes
replace dobyr="20"+dobyr if (agetxt!=6 & natregno!="")|regex(substr(dobyr,1,1),"[0]") //8 changes
replace dobyr="19"+dobyr if length(dobyr)==2 //898 changes
count if length(dobyr)>4 //0
count if dobday!="" & (dobday!="01"&dobday!="02"&dobday!="03"&dobday!="04"&dobday!="05"&dobday!="06"&dobday!="07"&dobday!="08"&dobday!="09"&dobday!="10"&dobday!="11"&dobday!="12" ///
		 &dobday!="13"&dobday!="14"&dobday!="15"&dobday!="16"&dobday!="17"&dobday!="18"&dobday!="19"&dobday!="20"&dobday!="21"&dobday!="22"&dobday!="23"&dobday!="24"&dobday!="25" ///
		 &dobday!="26"&dobday!="27"&dobday!="28"&dobday!="29"&dobday!="30"&dobday!="31") //1
/*list record_id ddda dobday natregno pname if dobday!="" & (dobday!="01"&dobday!="02"&dobday!="03"&dobday!="04"&dobday!="05"&dobday!="06"&dobday!="07"&dobday!="08"&dobday!="09"&dobday!="10"&dobday!="11"&dobday!="12" ///
		 &dobday!="13"&dobday!="14"&dobday!="15"&dobday!="16"&dobday!="17"&dobday!="18"&dobday!="19"&dobday!="20"&dobday!="21"&dobday!="22"&dobday!="23"&dobday!="24"&dobday!="25" ///
		 &dobday!="26"&dobday!="27"&dobday!="28"&dobday!="29"&dobday!="30"&dobday!="31")
*/
replace dobday="23" if record_id==2316 //1 change
replace natregno=subinstr(natregno,"83","23",.) if record_id==2316 //1 change
replace flag18=flag18+1 if record_id==2316 //1 change
replace corr_AH=corr_AH+1 if record_id==2316 //1 change

count if dobmon!="" & (dobmon!="01"&dobmon!="02"&dobmon!="03"&dobmon!="04"&dobmon!="05"&dobmon!="06"&dobmon!="07"&dobmon!="08"&dobmon!="09"&dobmon!="10"&dobmon!="11"&dobmon!="12") //3
//list record_id ddda dobmon natregno pname if dobmon!="" & (dobmon!="01"&dobmon!="02"&dobmon!="03"&dobmon!="04"&dobmon!="05"&dobmon!="06"&dobmon!="07"&dobmon!="08"&dobmon!="09"&dobmon!="10"&dobmon!="11"&dobmon!="12")
replace dobmon="07" if record_id==2290 //1 change
replace natregno=subinstr(natregno,"717","107",.) if record_id==2290 //1 change
replace dobmon="10" if record_id==3019 //1 change
replace natregno=subinstr(natregno,"20","10",.) if record_id==3019 //1 change
replace dobmon="12" if record_id==3039 //1 change
replace natregno=subinstr(natregno,"12","26",.) if record_id==3039 //1 change
replace natregno=subinstr(natregno,"42","41",.) if record_id==3039 //1 change
replace flag18=flag18+1 if record_id==2290|record_id==3019|record_id==3039 //3 changes
replace corr_intern=corr_intern+1 if record_id==3019|record_id==3039 //2 changes
replace corr_KG=corr_KG+1 if record_id==2290 //1 change

gen birthdate=dobyr+dobmon+dobday
gen dob=date(birthdate, "YMD")
format dob %tdCCYY-NN-DD
gen age2=int((dod - dob)/365.25) //now use this to assign missing age
count if age!=age2 & natregno!="" & dob!=. //29
sort record_id
//list record_id pname age age2 agetxt dod dob natregno if age!=age2 & natregno!=""
//replace age=95 if record_id==7 //1 change
//replace agetxt=6 if record_id==7 //1 change
replace age=age2 if age!=age2 & natregno!="" & dob!=. & record_id!=2258 & record_id!=3050 & record_id!=3242 //26 changes
//replace corr_NR=corr_NR+1 if record_id==7 //1 change
drop nrn dob dobday dobmon dobyr age2
rename natregno nrn


** mstatus: 1=Single 2=Married 3=Separated/Divorced 4=Widowed/Widow/Widower 99=ND: FLAG 19
** (42) missing
count if event==1 & mstatus==. //0


** occu: Text, if missing=99: FLAG 20
** (43) missing
count if event==1 & occu=="" //0
** (44) invalid 
count if event==1 & regexm(occu, "[a-z]") //69
//list record_id ddda occu if event==1 & regexm(occu, "[a-z]")
replace flag20=flag20+1 if event==1 & regexm(occu, "[a-z]") //69 changes
replace corr_intern=corr_intern+1 if event==1 & regexm(occu, "[a-z]")
replace occu=upper(occu) //69 changes
replace occu = rtrim(ltrim(itrim(occu))) //0 changes
count if event==1 & regexm(occu,"NIL")|event==1 & regexm(occu,"ND") //75
//list record_id ddda occu if event==1 & regexm(occu,"NIL")|event==1 & regexm(occu,"ND")
count if event==1 & occu=="NIL"|event==1 & occu=="ND" //24
//list record_id ddda occu if event==1 & occu=="NIL"|event==1 & occu=="ND"
replace flag20=flag20+1 if event==1 & occu=="NIL"|event==1 & occu=="ND" //24 changes
replace occu="99" if event==1 & occu=="NIL"|event==1 & occu=="ND" //24 changes
replace corr_AH=corr_AH+1 if record_id==2524|record_id==2534|record_id==2819|record_id==2852|record_id==3087|record_id==3090 //6 changes
replace corr_intern=corr_intern+1 if record_id==2238|record_id==2239|record_id==2240|record_id==2241|record_id==2247|record_id==2258 ///
		|record_id==2274|record_id==2493|record_id==2512|record_id==2693|record_id==2719|record_id==2721|record_id==3016|record_id==3032 ///
		|record_id==3050|record_id==3058|record_id==3213|record_id==3280 //18 changes


** durationnum: Integer - min=0, max=99, if missing=99: FLAG 21
** (45) missing
count if event==1 & durationnum==. //0
** (46) invalid
count if durationnum==999 & durationtxt!=. & durationtxt!=99 //3
//list record_id ddda durationnum durationtxt if durationnum==999 & durationtxt!=99
replace flag21=flag21+1 if durationnum==999 & durationtxt!=. & durationtxt!=99 //3 changes
replace durationtxt=99 if durationnum==999 & durationtxt!=. & durationtxt!=99 //3 changes
count if durationnum==99 & durationtxt==99 //0
//list record_id ddda durationnum durationtxt if durationnum==99 & durationtxt==99
replace corr_AH=corr_AH+1 if record_id==2312
replace corr_intern=corr_intern+1 if record_id==2250|record_id==2273
//replace durationnum=999 if durationnum==99 & durationtxt==99 //1 change


** durationtxt - 1 "Days" 2 "Weeks" 3 "Months" 4 "Years" 99 "ND": FLAG 22
** (47) missing
count if durationnum!=. & durationnum!=999 & durationtxt==. //0
//list record_id ddda durationnum durationtxt if durationnum!=. & durationtxt==.
** (48) possibly invalid
count if durationnum!=999 & durationtxt==99 //0
//list record_id ddda durationnum durationtxt onset* if durationnum!=999 & durationtxt==99
//replace flag22=flag22+1 if record_id==351 //1 change
//replace durationtxt=4 if record_id==351 //1 change


** cod1a: Text, if missing=99: FLAG 23
** (49) missing
count if event==1 & cod1a=="" //0
** (50) invalid
count if event==1 & regexm(cod1a, "[a-z]") //64
//list record_id ddda cod1a onsetnumcod1a onsettxtcod1a if event==1 & regexm(cod1a, "[a-z]")
replace flag23=flag23+1 if event==1 & regexm(cod1a, "[a-z]") //64 changes
replace corr_intern=corr_intern+1 if event==1 & regexm(cod1a, "[a-z]")
replace cod1a=upper(cod1a) //64 changes
replace cod1a = rtrim(ltrim(itrim(cod1a))) //6 changes
count if event==1 & regexm(cod1a,"NIL")|event==1 & regexm(cod1a,"ND") //74 - all correct
//list record_id ddda cod1a if event==1 & regexm(cod1a,"NIL")|event==1 & regexm(cod1a,"ND")


** onsetnumcod1a: Integer - min=0, max=99, if missing=99: FLAG 24
** (51) missing
count if event==1 & cod1a!="99" & onsetnumcod1a==. //0
** (52) possibly invalid
count if onsetnumcod1a==999 & onsettxtcod1a!=. & onsettxtcod1a!=99 //5
//list record_id ddda onsetnumcod1a onsettxtcod1a if onsetnumcod1a==999 & onsettxtcod1a!=. & onsettxtcod1a!=99
replace flag24=flag24+1 if onsetnumcod1a==999 & onsettxtcod1a!=. & onsettxtcod1a!=99 //5 changes
replace onsetnumcod1a=99 if onsetnumcod1a==999 & onsettxtcod1a!=. & onsettxtcod1a!=99 //5 changes
count if onsetnumcod1a==99 & onsettxtcod1a==99 //1
//list record_id ddda onsetnumcod1a onsettxtcod1a if onsetnumcod1a==99 & onsettxtcod1a==99
replace flag24=flag24+1 if onsetnumcod1a==99 & onsettxtcod1a==99 //1 change
replace onsetnumcod1a=999 if onsetnumcod1a==99 & onsettxtcod1a==99 //1 change
replace corr_intern=corr_intern+1 if record_id==2237|record_id==2250|record_id==2266|record_id==2273|record_id==2313|record_id==2404


** onsettxtcod1a: 1 "Days" 2 "Weeks" 3 "Months" 4 "Years" 99 "ND": FLAG 25
** (53) missing
count if onsetnumcod1a!=. & onsetnumcod1a!=999 & onsettxtcod1a==. //0
//list record_id ddda onsetnumcod1a onsettxtcod1a if onsetnumcod1a!=. & onsetnumcod1a!=999 & onsettxtcod1a==.
** (54) possibly invalid
count if onsetnumcod1a!=999 & onsettxtcod1a==99 //1 - correct
//list record_id ddda duration* onsetnumcod1a onsettxtcod1a onset* if onsetnumcod1a!=999 & onsettxtcod1a==99
//replace flag25=flag25+1 if onsetnumcod1a!=999 & onsettxtcod1a==99 & record_id!=1678 //4 changes
//replace onsettxtcod1a=2 if record_id==640


** cod1b: Text, if missing=99: FLAG 26
** (55) missing
count if event==1 & cod1b=="" //0
** (56) invalid
count if event==1 & regexm(cod1b, "[a-z]") //31
//list record_id ddda cod1b onsetnumcod1b onsettxtcod1b if event==1 & regexm(cod1b, "[a-z]")
replace flag26=flag26+1 if event==1 & regexm(cod1b, "[a-z]") //31 changes
replace corr_intern=corr_intern+1 if event==1 & regexm(cod1b, "[a-z]")
replace cod1b=upper(cod1b) //31 changes
replace cod1b = rtrim(ltrim(itrim(cod1b))) //4 changes
count if event==1 & regexm(cod1b,"NIL")|event==1 & regexm(cod1b,"ND") //30 - all correct
//list record_id ddda cod1b if event==1 & regexm(cod1b,"NIL")|event==1 & regexm(cod1b,"ND")


** onsetnumcod1b: Integer - min=0, max=99, if missing=99: FLAG 27
** (57) missing
count if event==1 & cod1b!="99" & onsetnumcod1b==. //2
//list record_id ddda cod1b onsetnumcod1b onsettxtcod1b if event==1 & cod1b!="99" & onsetnumcod1b==.
replace flag27=flag27+1 if event==1 & cod1b!="99" & onsetnumcod1b==. //2 changes
replace corr_intern=corr_intern+1 if event==1 & cod1b!="99" & onsetnumcod1b==.
replace onsetnumcod1b=999 if event==1 & cod1b!="99" & onsetnumcod1b==. //2 changes
** (58) possibly invalid
count if onsetnumcod1b==999 & onsettxtcod1b!=. & onsettxtcod1b!=99 //8
//list record_id ddda onsetnumcod1b onsettxtcod1b if onsetnumcod1b==999 & onsettxtcod1b!=. & onsettxtcod1b!=99
replace flag27=flag27+1 if onsetnumcod1b==999 & onsettxtcod1b!=. & onsettxtcod1b!=99 //8 changes
replace onsetnumcod1b=99 if onsetnumcod1b==999 & onsettxtcod1b!=. & onsettxtcod1b!=99 //8 changes
count if onsetnumcod1b==99 & onsettxtcod1b==99 //0
//list record_id ddda onsetnumcod1b onsettxtcod1b if onsetnumcod1b==99 & onsettxtcod1b==99
replace corr_intern=corr_intern+1 if record_id==2237|record_id==2243|record_id==2250|record_id==2257|record_id==2273 //5 changes
replace corr_KG=corr_KG+1 if record_id==2304 //1 change
replace corr_AH=corr_AH+1 if record_id==2310|record_id==2311 //2 changes


** onsettxtcod1b: 1 "Days" 2 "Weeks" 3 "Months" 4 "Years" 99 "ND": FLAG 28
** (59) missing
count if onsetnumcod1b!=. & onsetnumcod1b!=999 & onsettxtcod1b==. //0
//list record_id ddda onsetnumcod1b onsettxtcod1b if onsetnumcod1b!=. & onsetnumcod1b!=999 & onsettxtcod1b==.
** (60) possibly invalid
count if onsetnumcod1b!=999 & onsettxtcod1b==99 //65 - all correct
//list record_id ddda duration* onsetnumcod1b onsettxtcod1b if onsetnumcod1b!=999 & onsettxtcod1b==99
//replace flag28=flag28+1 if onsetnumcod1b!=999 & onsettxtcod1b==99 & record_id!=1643 //3 changes


** cod1c: Text, if missing=99: FLAG 29
** (61) missing
count if event==1 & cod1c=="" //0
** (62) invalid
count if event==1 & regexm(cod1c, "[a-z]") //13
//list record_id ddda cod1c onsetnumcod1c onsettxtcod1c if event==1 & regexm(cod1c, "[a-z]")
replace flag29=flag29+1 if event==1 & regexm(cod1c, "[a-z]") //31 changes
replace corr_intern=corr_intern+1 if event==1 & regexm(cod1c, "[a-z]")
replace cod1c=upper(cod1c) //13 changes
replace cod1c = rtrim(ltrim(itrim(cod1c))) //3 changes
count if event==1 & regexm(cod1c,"NIL")|event==1 & regexm(cod1c,"ND") //6 - all correct
//list record_id ddda cod1c if event==1 & regexm(cod1c,"NIL")|event==1 & regexm(cod1c,"ND")


** onsetnumcod1c: Integer - min=0, max=99, if missing=99: FLAG 30
** (63) missing
count if event==1 & cod1c!="99" & onsetnumcod1c==. //1
//list record_id ddda cod1c onsetnumcod1c onsettxtcod1c if event==1 & cod1c!="99" & onsetnumcod1c==.
replace flag30=flag30+1 if event==1 & cod1c!="99" & onsetnumcod1c==. //1 change
replace corr_intern=corr_intern+1 if event==1 & cod1c!="99" & onsetnumcod1c==.
replace onsetnumcod1c=999 if event==1 & cod1c!="99" & onsetnumcod1c==. //1 change
** (64) possibly invalid
count if onsetnumcod1c==999 & onsettxtcod1c!=. & onsettxtcod1c!=99 //5
//list record_id ddda onsetnumcod1c onsettxtcod1c if onsetnumcod1c==999 & onsettxtcod1c!=. & onsettxtcod1c!=99
replace flag30=flag30+1 if onsetnumcod1c==999 & onsettxtcod1c!=. & onsettxtcod1c!=99 //5 changes
replace onsetnumcod1c=99 if onsetnumcod1c==999 & onsettxtcod1c!=. & onsettxtcod1c!=99 //5 changes
count if onsetnumcod1c==99 & onsettxtcod1c==99 //0
//list record_id ddda onsetnumcod1c onsettxtcod1c if onsetnumcod1c==99 & onsettxtcod1c==99
replace corr_intern=corr_intern+1 if record_id==2243|record_id==2257|record_id==2273
replace corr_KG=corr_KG+1 if record_id==2304|record_id==2305


** onsettxtcod1c: 1 "Days" 2 "Weeks" 3 "Months" 4 "Years" 99 "ND": FLAG 31
** (65) missing
count if onsetnumcod1c!=. & onsetnumcod1c!=999 & onsettxtcod1c==. //0
//list record_id ddda onsetnumcod1c onsettxtcod1c if onsetnumcod1c!=. & onsettxtcod1c==.
** (66) possibly invalid
count if onsetnumcod1c!=999 & onsettxtcod1c==99 //112
//list record_id ddda duration* onsetnumcod1c onsettxtcod1c if onsetnumcod1c!=999 & onsettxtcod1c==99
//replace flag28=flag28+1 if onsetnumcod1c!=999 & onsettxtcod1c==99 & record_id!=1570 //1 changes


** cod1d: Text, if missing=99: FLAG 32
** (67) missing
count if event==1 & cod1d=="" //0
//list record_id ddda cod1d if event==1 & cod1d==""
** (68) invalid
count if event==1 & regexm(cod1d, "[a-z]") //1
//list record_id ddda cod1d onsetnumcod1d onsettxtcod1d if event==1 & regexm(cod1d, "[a-z]")
replace flag32=flag32+1 if event==1 & regexm(cod1d, "[a-z]") //1 change
replace corr_intern=corr_intern+1 if event==1 & regexm(cod1d, "[a-z]")
replace cod1d=upper(cod1d) //1 change
replace cod1d = rtrim(ltrim(itrim(cod1d))) //0 changes
count if event==1 & regexm(cod1d,"NIL")|event==1 & regexm(cod1d,"ND") //6 - all correct
//list record_id ddda cod1d if event==1 & regexm(cod1d,"NIL")|event==1 & regexm(cod1d,"ND")


** onsetnumcod1d: Integer - min=0, max=99, if missing=99: FLAG 33
** (69) missing
count if event==1 & cod1d!="99" & onsetnumcod1d==. //0
//list record_id ddda cod1d onsetnumcod1d onsettxtcod1d if event==1 & cod1d!="99" & onsetnumcod1d==.
** (70) possibly invalid
count if onsetnumcod1d==999 & onsettxtcod1d!=. & onsettxtcod1d!=99 //2
//list record_id ddda onsetnumcod1d onsettxtcod1d if onsetnumcod1d==999 & onsettxtcod1d!=. & onsettxtcod1d!=99
replace flag33=flag33+1 if onsetnumcod1d==999 & onsettxtcod1d!=. & onsettxtcod1d!=99 //2 changes
replace onsetnumcod1d=99 if onsetnumcod1d==999 & onsettxtcod1d!=. & onsettxtcod1d!=99 //2 changes
count if onsetnumcod1d==99 & onsettxtcod1d==99 //0
//list record_id ddda onsetnumcod1d onsettxtcod1d if onsetnumcod1d==99 & onsettxtcod1d==99
replace corr_intern=corr_intern+1 if record_id==2273
replace corr_KG=corr_KG+1 if record_id==2304


** onsettxtcod1d: 1 "Days" 2 "Weeks" 3 "Months" 4 "Years" 99 "ND": FLAG 34
** (71) missing
count if onsetnumcod1d!=. & onsetnumcod1d!=999 & onsettxtcod1d==. //1
//list record_id ddda onsetnumcod1d onsettxtcod1d if onsetnumcod1d!=. & onsetnumcod1d!=999 & onsettxtcod1d==.
replace flag34=flag34+1 if onsetnumcod1d!=. & onsetnumcod1d!=999 & onsettxtcod1d==. //1 change
** (72) possibly invalid
count if onsetnumcod1d!=999 & onsettxtcod1d==99 //136 - all correct
//list record_id ddda duration* onsetnumcod1d onsettxtcod1d if onsetnumcod1d!=999 & onsettxtcod1d==99
replace corr_intern=corr_intern+1 if record_id==2532


** cod2a: Text, if missing=99: FLAG 35
** (73) missing
count if event==1 & cod2a=="" //0
//list record_id ddda cod2a if event==1 & cod2a==""
** (74) invalid
count if event==1 & regexm(cod2a, "[a-z]") //20
//list record_id ddda cod2a onsetnumcod2a onsettxtcod2a if event==1 & regexm(cod2a, "[a-z]")
replace flag35=flag35+1 if event==1 & regexm(cod2a, "[a-z]") //20 changes
replace corr_intern=corr_intern+1 if event==1 & regexm(cod2a, "[a-z]")
replace cod2a=upper(cod2a) //20 changes
replace cod2a = rtrim(ltrim(itrim(cod2a))) //3 changes
//replace corr_KG=corr_KG+1 if record_id==12 //1 change
count if event==1 & regexm(cod2a,"NIL")|event==1 & regexm(cod2a,"ND") //10 - all correct
//list record_id ddda cod2a if event==1 & regexm(cod2a,"NIL")|event==1 & regexm(cod2a,"ND")


** onsetnumcod2a: Integer - min=0, max=99, if missing=99: FLAG 36
** (75) missing
count if event==1 & cod2a!="99" & onsetnumcod2a==. //1
//list record_id ddda cod2a onsetnumcod2a onsettxtcod2a if event==1 & cod2a!="99" & onsetnumcod2a==.
replace flag36=flag36+1 if event==1 & cod2a!="99" & onsetnumcod2a==. //1 change
replace corr_intern=corr_intern+1 if event==1 & cod2a!="99" & onsetnumcod2a==.
replace onsetnumcod2a=999 if event==1 & cod2a!="99" & onsetnumcod2a==. //1 change
** (76) possibly invalid
count if onsetnumcod2a==999 & onsettxtcod2a!=. & onsettxtcod2a!=99 //6
//list record_id ddda onsetnumcod2a onsettxtcod2a if onsetnumcod2a==999 & onsettxtcod2a!=. & onsettxtcod2a!=99
replace flag36=flag36+1 if onsetnumcod2a==999 & onsettxtcod2a!=. & onsettxtcod2a!=99 //6 changes
replace onsetnumcod2a=99 if onsetnumcod2a==999 & onsettxtcod2a!=. & onsettxtcod2a!=99 //6 changes
count if onsetnumcod2a==99 & onsettxtcod2a==99 //1
//list record_id ddda onsetnumcod2a onsettxtcod2a if onsetnumcod2a==99 & onsettxtcod2a==99
replace corr_KG=corr_KG+1 if record_id==2304|record_id==2305 //2 changes
replace corr_intern=corr_intern+1 if record_id==2266|record_id==2273 //2 changes
replace corr_AH=corr_AH+1 if record_id==2312|record_id==2340 //2 changes


** onsettxtcod2a: 1 "Days" 2 "Weeks" 3 "Months" 4 "Years" 99 "ND": FLAG 37
** (77) missing
count if onsetnumcod2a!=. & onsetnumcod2a!=999 & onsettxtcod2a==. //0
//list record_id ddda onsetnumcod2a onsettxtcod2a if onsetnumcod2a!=. & onsetnumcod2a!=999 & onsettxtcod2a==.
//replace flag37=flag37+1 if record_id==967 //1 change
//replace corr_KG=corr_KG+1 if record_id==967 //1 change
//replace onsettxtcod2a=99 if onsetnumcod2a!=. & onsettxtcod2a==. //1 change
** (78) possibly invalid
count if onsetnumcod2a!=999 & onsettxtcod2a==99 //93 - all correct
//list record_id ddda duration* onsetnumcod2a onsettxtcod2a if onsetnumcod2a!=999 & onsettxtcod2a==99
//replace flag37=flag37+1 if onsetnumcod2a!=999 & onsettxtcod2a==99 & record_id!=859 & record_id!=1599 //1 change


** cod2b: Text, if missing=99: FLAG 38
** (79) missing
count if event==1 & cod2b=="" //0
//list record_id ddda cod2b if event==1 & cod2b==""
** (80) invalid
count if event==1 & regexm(cod2b, "[a-z]") //9
//list record_id ddda cod2b onsetnumcod2b onsettxtcod2b if event==1 & regexm(cod2b, "[a-z]")
replace flag38=flag38+1 if event==1 & regexm(cod2b, "[a-z]") //9 changes
replace corr_intern=corr_intern+1 if event==1 & regexm(cod2b, "[a-z]")
replace cod2b=upper(cod2b) //9 changes
replace cod2b = rtrim(ltrim(itrim(cod2b))) //4 changes
count if event==1 & regexm(cod2b,"NIL")|event==1 & regexm(cod2b,"ND") //3 - all correct
//list record_id ddda cod2b if event==1 & regexm(cod2b,"NIL")|event==1 & regexm(cod2b,"ND")


** onsetnumcod2b: Integer - min=0, max=99, if missing=99: FLAG 39
** (81) missing
count if event==1 & cod2b!="99" & onsetnumcod2b==. //0
//list record_id ddda cod2b onsetnumcod2b onsettxtcod2b if event==1 & cod2b!="99" & onsetnumcod2b==.
** (82) possibly invalid
count if onsetnumcod2b==999 & onsettxtcod2b!=. & onsettxtcod2b!=99 //3
//list record_id ddda onsetnumcod2b onsettxtcod2b if onsetnumcod2b==999 & onsettxtcod2b!=. & onsettxtcod2b!=99
replace flag39=flag39+1 if onsetnumcod2b==999 & onsettxtcod2b!=. & onsettxtcod2b!=99 //3 changes
replace onsetnumcod2b=99 if onsetnumcod2b==999 & onsettxtcod2b!=. & onsettxtcod2b!=99 //3 changes
count if onsetnumcod2b==99 & onsettxtcod2b==99 //1 - correct
//list record_id ddda onsetnumcod2b onsettxtcod2b if onsetnumcod2b==99 & onsettxtcod2b==99
replace corr_KG=corr_KG+1 if record_id==2305 //1 change
replace corr_intern=corr_intern+1 if record_id==2273 //1 change
replace corr_AH=corr_AH+1 if record_id==2312 //1 change


** onsettxtcod2b: 1 "Days" 2 "Weeks" 3 "Months" 4 "Years" 99 "ND": FLAG 40
** (83) missing
count if onsetnumcod2b!=. & onsetnumcod2b!=999 & onsettxtcod2b==. //0
//list record_id ddda onsetnumcod2b onsettxtcod2b if onsetnumcod2b!=. & onsetnumcod2b!=999 & onsettxtcod2b==.
** (84) possibly invalid
count if onsetnumcod2b!=999 & onsettxtcod2b==99 //121 - all correct except 1
//list record_id ddda duration* onsetnumcod2b onsettxtcod2b if onsetnumcod2b!=999 & onsettxtcod2b==99
replace flag40=flag40+1 if record_id==2342
replace corr_AH=corr_AH+1 if record_id==2342 //1 change
replace onsetnumcod2b=999 if record_id==2342 //1 change
replace onsettxtcod2b=. if record_id==2342 //1 change


** pod: Text, if missing=99: FLAG 41
** (85) missing
count if event==1 & pod=="" //0
//list record_id ddda pod if event==1 & pod==""
** (86) invalid
count if event==1 & regexm(pod, "[a-z]") //74
//list record_id ddda pod if event==1 & regexm(pod, "[a-z]")
replace flag41=flag41+1 if event==1 & regexm(pod, "[a-z]")
replace corr_AH=corr_AH+1 if record_id==3091 //1 change
replace corr_intern=corr_intern+1 if event==1 & regexm(pod, "[a-z]") & record_id!=3091 //73 changes
replace pod=upper(pod) //74 changes
replace pod = rtrim(ltrim(itrim(pod))) //14 changes
count if event==1 & regexm(pod,"NIL")|event==1 & regexm(pod,"ND") //72 - all correct
//list record_id ddda pod if event==1 & regexm(pod,"NIL")|event==1 & regexm(pod,"ND")


** deathparish: FLAG 42
** (87) missing
count if event==1 & deathparish==. //0
//list record_id ddda deathparish if event==1 & deathparish==.
** (88) invalid - see district demarcations noted below:
/*	Districts are assigned based on death parish
		District A - anything below top rock christ church and st. michael 
		District B - anything above top rock christ church and st. george
		District C - st. philip and st. john
		District D - st. thomas
		District E - st. james, st. peter, st. lucy
		District F - st. joseph, st. andrew
*/
** (88) Christ Church
count if deathparish==1 & district!=1 //59 - all correct
//list record_id ddda district pod deathparish if deathparish==1 & district!=1
** (89) St Andrew
count if deathparish==2 & district!=6 //0
//list record_id ddda deathparish district pod if deathparish==2 & district!=6
** (90) St George
count if deathparish==3 & district!=2 //0
//list record_id ddda deathparish district pod if deathparish==3 & district!=2
** (91) St James
count if deathparish==4 & district!=5 //1
//list record_id ddda deathparish district pod if deathparish==4 & district!=5
replace flag42=flag42+1 if record_id==2360 // change
replace corr_intern=corr_intern+1 if record_id==2360 // change
replace district=5 if record_id==2360 // change
** (92) St John
count if deathparish==5 & district!=3 //0
//list record_id ddda deathparish district pod if deathparish==5 & district!=3
** (93) St Joseph
count if deathparish==6 & district!=6 //0
//list record_id ddda deathparish district pod if deathparish==6 & district!=6
** (94) St Joseph
count if deathparish==7 & district!=5 //0
//list record_id ddda deathparish district pod if deathparish==7 & district!=5
** (95) St Michael
count if deathparish==8 & district!=1 //0
//list record_id ddda deathparish district pod if deathparish==8 & district!=1
** (96) St Peter
count if deathparish==9 & district!=5 //2
//list record_id ddda deathparish district pod if deathparish==9 & district!=5
replace flag42=flag42+1 if record_id==2370|record_id==2556 //2 changes
replace corr_intern=corr_intern+1 if record_id==2370|record_id==2556 //2 changes
replace deathparish=8 if record_id==2370 //1 change
replace district=5 if record_id==2556 // change
** (97) St Philip
count if deathparish==10 & district!=3 //1
//list record_id ddda deathparish district pod if deathparish==10 & district!=3
replace flag42=flag42+1 if record_id==2640 //1 change
replace corr_KG=corr_KG+1 if record_id==2640 //1 change
replace district=3 if record_id==2640 //1 change
** (98) St Thomas
count if deathparish==11 & district!=4 //1
//list record_id ddda deathparish district pod if deathparish==11 & district!=4
replace flag42=flag42+1 if record_id==2681 //1 change
replace corr_TH=corr_TH+1 if record_id==2681 //1 change
replace district=4 if record_id==2681 //1 change


** regdate: Y-M-D: FLAG 43
** (99) missing
count if event==1 & regdate==. //0
//list record_id ddda dod regdate if event==1 & regdate==.
** (100) invalid - future date
count if event==1 & regdate!=. & regdate>today //0
sort record_id
//list record_id ddda dod regdate pname if event==1 & regdate!=. & regdate>today
//replace pname=subinstr(pname,"J","JO",.) if record_id==1789 //1 change
//replace flag43=flag43+1 if record_id==1789
//replace corr_intern=corr_intern+1 if record_id==1789
//replace regdate=regdate-365.25 if record_id==1789 //1 change
//replace flag43=flag43+1 if record_id==1789
//replace corr_intern=corr_intern+1 if record_id==1789 //1 change
drop today


** certifier: Text, if missing=99: FLAG 44
** (101) missing
count if event==1 & certifier=="" //0
//list record_id ddda certifier if event==1 & certifier==""
count if certifier=="999" //0
//replace flag44=flag44+1 if record_id==163 //1 change
//replace corr_AH=corr_AH+1 if record_id==163 //1 change
//replace certifier="99" if certifier=="999" //1 change
** (102) invalid
count if event==1 & regexm(certifier, "[a-z]") //66
//list record_id ddda certifier if event==1 & regexm(certifier, "[a-z]")
replace flag44=flag44+1 if event==1 & regexm(certifier, "[a-z]") //66 changes
replace corr_intern=corr_intern+1 if event==1 & regexm(certifier, "[a-z]") //66 changes
replace certifier=upper(certifier) //66 changes
replace certifier = rtrim(ltrim(itrim(certifier))) //6 changes
count if event==1 & regexm(certifier,"NIL")|event==1 & regexm(certifier,"ND") //83 - all correct
//list record_id ddda certifier if event==1 & regexm(certifier,"NIL")|event==1 & regexm(certifier,"ND")


** certifieraddr: Text, if missing=99: FLAG 45
** (103) missing
count if event==1 & certifieraddr=="" //0
//list record_id ddda certifieraddr if event==1 & certifieraddr==""
** (104) invalid
count if event==1 & regexm(certifieraddr, "[a-z]") //54
//list record_id ddda certifieraddr if event==1 & regexm(certifieraddr, "[a-z]")
replace flag45=flag45+1 if event==1 & regexm(certifieraddr, "[a-z]") //54 changes
replace corr_AH=corr_AH+1 if record_id==2308|record_id==2808 //1 change
replace corr_intern=corr_intern+1 if event==1 & regexm(certifieraddr, "[a-z]") & record_id!=2308 & record_id!=2808 //52 changes
replace certifieraddr=upper(certifieraddr) //54 changes
replace certifieraddr = rtrim(ltrim(itrim(certifieraddr))) //12 changes
count if event==1 & regexm(certifieraddr,"NIL")|event==1 & regexm(certifieraddr,"ND") //25 - all correct
//list record_id ddda certifieraddr if event==1 & regexm(certifieraddr,"NIL")|event==1 & regexm(certifieraddr,"ND")


** namematch: readonly: FLAG 46
** (105) missing
count if event==1 & namematch==. //941 - already checked for duplicates above
replace namematch=2 if event==1 & namematch==. //941 changes
//list record_id ddda namematch if event==1 & namematch==.


** cleaned: 1=Yes; 2=No: FLAG 47
** (105) missing
count if event==1 & cleaned==. //945
replace cleaned=1 if event==1 & cleaned==. //945 changes


** death_certificate_complete (auto-generated by REDCap): 0=Incomplete 1=Unverified 2=Complete: FLAG 48
** (106) missing
count if event==1 & recstatdc==. //0
** (107) invalid - incomplete and no reason given in field comment of redcapdb
count if event==1 & recstatdc==0 //0
//list record_id ddda dddoa recstatdc if event==1 & recstatdc==0
** (108) invalid - unverified and no reason given in field comment of redcapdb
count if event==1 & recstatdc==1 //0



*******************
** TRACKING FORM **
*******************

** tfdddoa: Y-M-D, readonly: FLAG 49
** (109) missing
count if event==2 & tfdddoa==. //37
//list record_id tfdddoaend if event==2 & tfdddoa==.
replace tfdddoa=tfdddoaend if event==2 & tfdddoa==. //37 changes


** tfdddoatstart: H:M, readonly: FLAG 50
** (110) missing
count if event==2 & tfdddoatstart==. //0


** tfddda: readonly, user logged into redcap: FLAG 51
** (111) missing
count if event==2 & tfddda==. //4 - checked Logging in REDCap db
//list record_id if event==2 & tfddda==.
replace tfddda=98 if record_id==2347|record_id==2397|record_id==2734|record_id==3289 //4 changes


** tfregnumstart: integer: FLAG 52
** (112) missing
count if event==2 & tfregnumstart==. //0


** tfdistrictstart: letters only: FLAG 53
** (113) missing
count if event==2 & tfdistrictstart=="" //0
** (114) invalid
count if event==2 & regexm(tfdistrictstart, "[a-z]") //0
//replace tfdistrictstart = rtrim(ltrim(itrim(tfdistrictstart))) //0 changes


** tfregnumend: integer: FLAG 54
** (115) missing
count if event==2 & tfregnumend==. //0
//list record_id tfddda tfregnumend if event==2 & tfregnumend==.


** tfdistrictend: letters only: FLAG 55
** (116) missing
count if event==2 & tfdistrictend=="" //0
//list record_id tfddda tfdistrictend if event==2 & tfdistrictend==""
** (117) invalid
count if event==2 & regexm(tfdistrictend, "[a-z]") //0
//replace tfdistrictend = rtrim(ltrim(itrim(tfdistrictend))) //0 changes


** tfdddoaend: Y-M-D, readonly: FLAG 56
** (118) missing
count if event==2 & tfdddoaend==. //2
//list record_id tfdddoa if event==2 & tfdddoaend==.
replace tfdddoaend=tfdddoa if event==2 & tfdddoaend==. //2 changes


** tfdddoatend: H:M, readonly: FLAG 57
** (119) missing
count if event==2 & tfdddoatend==. //3
//list record_id tfddda tfdddoatstart if event==2 & tfdddoatend==.


** tfddelapsedh: auto-generated, readonly: FLAG 58
** (120) missing
count if tfdddoatstart!=. & tfdddoatend!=. & tfddelapsedh==. //0
//list record_id tfddda tfdddoatstart tfdddoatend if tfdddoatstart!=. & tfdddoatend!=. & tfddelapsedh==.


** tfddelapsedm: auto-generated, readonly: FLAG 59
** (120) missing
count if tfdddoatstart!=. & tfdddoatend!=. & tfddelapsedm==. //0
//list record_id tfddda tfdddoatstart tfdddoatend if tfdddoatstart!=. & tfdddoatend!=. & tfddelapsedm==.


** tfddtxt: FLAG 60
replace tfddtxt = rtrim(ltrim(itrim(tfddtxt))) //21 changes


** tracking_complete (auto-generated by REDCap): 0=Incomplete 1=Unverified 2=Complete: FLAG 61
** (121) missing
count if event==2 & recstattf==. //0
** (122) invalid - incomplete and no reason given in field comment of redcapdb
count if event==2 & recstattf==0 //1 - correct
//list record_id tfddda tfdddoa recstattf if event==2 & recstattf==0
** (123) invalid - unverified and no reason given in field comment of redcapdb
count if event==2 & recstattf==1 //0

** REMOVE dod>2019
drop if event==1 & dodyear>2019 //0 deleted - already deleted above

** ORDER variables according to position in DeathData REDCap database
order record_id redcap_event_name event dddoa ddda odda certtype regnum district pname address parish ///
	  sex age agetxt nrnnd nrn mstatus occu durationnum durationtxt dod dodyear ///
	  cod1a onsetnumcod1a onsettxtcod1a cod1b onsetnumcod1b onsettxtcod1b ///
	  cod1c onsetnumcod1c onsettxtcod1c cod1d onsetnumcod1d onsettxtcod1d ///
	  cod2a onsetnumcod2a onsettxtcod2a cod2b onsetnumcod2b onsettxtcod2b ///
	  pod deathparish regdate certifier certifieraddr namematch cleaned recstatdc ///
	  tfdddoa tfdddoatstart tfddda tfregnumstart tfdistrictstart tfregnumend tfdistrictend ///
      tfddelapsedh tfddelapsedm tfdddoaend tfdddoatend tfddtxt recstattf

count //984

label data "BNR MORTALITY data 2008-2019"
notes _dta :These data prepared from BB national death register & BNR (Redcap) deathdata database
save "`datapath'\version03\3-output\2019_deaths_cleaned_dqi_dc_v02" ,replace


** REMOVE variables and labels not needed in DeathData REDCap database
drop birthdate flag*
label drop _all

** REDCap will not import H:M:S format so had to change cfdate from %tcCCYY-NN-DD_HH:MM:SS to below format
format dddoa %tcCCYY-NN-DD_HH:MM
	  
count //984

label data "BNR MORTALITY data 2008-2019"
notes _dta :These data prepared from BB national death register & BNR (Redcap) deathdata database
save "`datapath'\version03\3-output\2019_deaths_cleaned_export_dc_v02" ,replace

